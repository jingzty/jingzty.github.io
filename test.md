## 问题

有A B C三台主机，系统都是centos，A和C都在内网，B在公网。

即正常情况下，A和C都不能被直接访问，B可以被直接访问。

利用SSH的反向代理功能，可以实现B可以直接访问A，再利用SSH的正向代理，就可以实现C通过B来访问A。

这种方法需要一台国内的vps支持，外网的速度慢，但是国内的又贵，我是正好有一台国内的vps才用的这个方法。

## 详细

命令很简单，在内网A上启用反向代理：
```
ssh -fCNR 22022:localhost:22 root@139.224.10.128
```
输入B的root密码，这样就在A上建立了到B的反向代理，这时在B上直接访问到localhost:22022就可以访问到A了。

在B上启用正向代理：
```
ssh -fCNL  *:22023:localhost:22022 root@localhost
```
这里也是输入B的root密码，换成其他用户应该是比较安全点。这时，C可以通过访问B:22023来访问A了。

参数解析：

```
-f 后台运行
-C 允许压缩数据（不需要）
-N 不执行任何命令
-R 将端口绑定到远程服务器，反向代理
-L 将端口绑定到本地客户端，正向代理
```

## 强化

SSH的连接并不稳定，我放在宿舍的A，万一断电重启，或者没重启连接也可能会断开，这样我就无法访问A了。所以需要autossh来建立稳定的ssh连接。

在A上使用autossh：
```
autossh -M 5678 -fNR 22022:localhost:22 root@139.224.10.128
```
貌似用上autossh的话，就不会断，或者说，断开会自动连。（用ssh的时候，一两天大概就会断开）

## 免密码

现在还有一个问题，就是建立ssh连接时，需要输入B的密码，这里我使用了公钥，这样就可以免密码登陆B了。

在A上：
```
ssh-keygen -t dsa   #-t的参数就是生成用dsa加密的密钥，默认是rsa
```
不输入密码，全部默认y，这样会在/root/.ssh下生成两个文件：  
id_dsa，id_dsa.pub

id_dsa.pub里面的内容，复制到B上/root/.ssh/authorized_keys里面，就可以实现A免密码登陆B了。

## 自启动

最后还有一个问题，重启自动运行。

这个问题还比较棘手，我在/etc/rc.local里面直接添加那条命令，好像没什么用，我只好将这条命令添加到脚本里面，然后在/etc/rc.local里面添加启动脚本的命令，脚本和启动项里面，用绝对路径。

用绝对路径的原因是据说系统在重启的时候，还未加载环境变量，命令不知道在哪，有点道理。

如下：
```
/bin/bash /home/autossh.sh   #脚本中添加内容
```

```
[root@centos ~]# cat /home/autossh.sh 
#! /bin/bash
/usr/local/bin/autossh -M 5678 -fCNR 22022:localhost:22 root@139.224.10.128
```
